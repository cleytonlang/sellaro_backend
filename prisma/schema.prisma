// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  name            String
  email           String    @unique
  emailVerified   Boolean   @default(false)
  image           String?
  openai_api_key  String?   // encrypted
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now()) @updatedAt

  // Better-auth relations
  sessions        Session[]
  accounts        Account[]

  // App relations
  forms           Form[]
  assistants      Assistant[]
  lead_comments   LeadComment[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Assistant {
  id                    String   @id @default(cuid())
  userId                String
  name                  String
  system_prompt         String   @db.Text
  initial_message       String   @db.Text
  temperature           Float    @default(0.7)
  model                 String   @default("gpt-4-turbo-preview")
  openai_assistant_id   String?  // ID from OpenAI API

  // Token limits for cost control
  max_completion_tokens Int?     @default(500)  // Max tokens in assistant response (default: small messages)
  max_prompt_tokens     Int?     // Max tokens in prompt/input (null = unlimited)

  // Trigger settings
  enable_scheduling     Boolean  @default(true)
  enable_email          Boolean  @default(true)
  enable_link_sharing   Boolean  @default(true)

  created_at            DateTime @default(now())

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  forms                 Form[]
  conversations         Conversation[]
  triggers              Trigger[]

  @@index([userId])
  @@map("assistant")
}

model Form {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?  @db.Text

  // Field configuration
  fields      Json     // Array of form fields

  // Visual settings
  settings    Json?    // Theme, buttons, etc settings

  // Embed
  embed_code  String   @unique @default(cuid())
  is_active   Boolean  @default(true)

  // Associated assistant
  assistant_id String?

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assistant   Assistant? @relation(fields: [assistant_id], references: [id])
  leads       Lead[]
  kanban_columns KanbanColumn[]

  @@index([userId])
  @@index([assistant_id])
  @@index([embed_code])
  @@map("form")
}

model Lead {
  id                String   @id @default(cuid())
  form_id           String
  kanban_column_id  String

  // Form submitted data
  form_data         Json

  // Metadata
  ip_address        String?
  user_agent        String?
  referrer_url      String?

  // Soft delete
  deleted_at        DateTime?

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  form              Form     @relation(fields: [form_id], references: [id])
  kanban_column     KanbanColumn @relation(fields: [kanban_column_id], references: [id], onDelete: Cascade)
  conversations     Conversation[]
  events            LeadEvent[]
  comments          LeadComment[]
  movement_logs     LeadMovementLog[]

  @@index([form_id])
  @@index([kanban_column_id])
  @@index([created_at])
  @@index([deleted_at])
  @@map("lead")
}

model Conversation {
  id            String   @id @default(cuid())
  lead_id       String
  assistant_id  String
  thread_id     String?  // OpenAI Thread ID
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  lead          Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  assistant     Assistant @relation(fields: [assistant_id], references: [id])
  messages      Message[]

  @@index([lead_id])
  @@index([assistant_id])
  @@map("conversation")
}

model Message {
  id              String   @id @default(cuid())
  conversation_id String
  role            String   // user, assistant, system
  content         String   @db.Text
  function_call   Json?    // If AI executed any function
  created_at      DateTime @default(now())

  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@index([created_at])
  @@map("message")
}

model LeadEvent {
  id          String   @id @default(cuid())
  lead_id     String
  type        String   // FORM_SUBMITTED, CHAT_STARTED, MEETING_SCHEDULED, EMAIL_SENT, LINK_SHARED
  data        Json
  created_at  DateTime @default(now())

  lead        Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  @@index([lead_id])
  @@index([type])
  @@index([created_at])
  @@map("lead_event")
}

model KanbanColumn {
  id          String   @id @default(cuid())
  form_id     String
  name        String
  order       Int
  color       String?
  created_at  DateTime @default(now())

  form        Form     @relation(fields: [form_id], references: [id], onDelete: Cascade)
  leads       Lead[]
  webhooks    ColumnWebhook[]

  @@index([form_id])
  @@index([order])
  @@map("kanban_column")
}

model ColumnWebhook {
  id                String   @id @default(cuid())
  kanban_column_id  String
  endpoint_url      String
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  kanban_column     KanbanColumn @relation(fields: [kanban_column_id], references: [id], onDelete: Cascade)

  @@index([kanban_column_id])
  @@map("column_webhook")
}

model LeadComment {
  id          String   @id @default(cuid())
  lead_id     String
  user_id     String
  content     String   @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  lead        Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([lead_id])
  @@index([user_id])
  @@index([created_at])
  @@map("lead_comment")
}

model Trigger {
  id            String   @id @default(cuid())
  assistant_id  String
  type          String   // CHANGE_STAGE, SEND_EMAIL
  order         Int      // Order of execution
  identifier    String   @unique @default("")  // Unique identifier: #<id><random10>#

  // Configuration data (JSON structure depends on type)
  // For CHANGE_STAGE: { formId, kanbanColumnId }
  // For SEND_EMAIL: { recipients, subject, content }
  //   - recipients: String with comma-separated emails (e.g., "email1@example.com,email2@example.com")
  config        Json

  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  assistant     Assistant @relation(fields: [assistant_id], references: [id], onDelete: Cascade)
  logs          TriggerLog[]

  @@index([assistant_id])
  @@index([type])
  @@index([order])
  @@index([identifier])
  @@map("trigger")
}

model TriggerLog {
  id            String   @id @default(cuid())
  trigger_id    String
  lead_id       String
  type          String   // CHANGE_STAGE, SEND_EMAIL

  // Data that was used/changed
  data          Json

  // Result
  success       Boolean
  error_message String?  @db.Text

  created_at    DateTime @default(now())

  trigger       Trigger  @relation(fields: [trigger_id], references: [id], onDelete: Cascade)

  @@index([trigger_id])
  @@index([lead_id])
  @@index([type])
  @@index([created_at])
  @@map("trigger_log")
}

model LeadMovementLog {
  id                    String   @id @default(cuid())
  lead_id               String
  from_column_id        String?
  to_column_id          String
  from_column_name      String?
  to_column_name        String
  movement_type         String   // MANUAL, TRIGGER, INITIAL
  trigger_id            String?  // If moved by trigger
  user_id               String?  // If moved manually
  created_at            DateTime @default(now())

  lead                  Lead     @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  @@index([lead_id])
  @@index([from_column_id])
  @@index([to_column_id])
  @@index([movement_type])
  @@index([created_at])
  @@map("lead_movement_log")
}
